/*! waterfall-panel - v0.1.0 - 2016-02-14
* https://github.com/senntyou/waterfall-panel
* Copyright (c) 2016 senntyou; Licensed MIT */
(function(t,e,i,s){"use strict";function a(e,i){this.$element=t(e),this.options=t.extend(!0,{},n,i),this.width=0,this.height=0,this.styleQueue=[],this.itemsData=[],this._init()}var h=t(e),o="waterfallPanel",n={itemCls:"waterfall-panel-item",prefix:"waterfall-panel",fitWidth:!0,cellWidth:380,cellHeight:280,gutterWidth:20,gutterHeight:20,align:"center",minRow:1,maxRow:s,maxPage:s,bufferPixel:-50,containerStyle:{position:"relative"},resizable:!0,isFadeIn:!1,isAnimated:!1,animationOptions:{},isAutoPrefill:!0,path:s,dataType:"json",params:{},headers:{},loadingMsg:'<div style="text-align:center;padding:10px 0; color:#999;"><img src="data:image/gif;base64,R0lGODlhEAALAPQAAP///zMzM+Li4tra2u7u7jk5OTMzM1hYWJubm4CAgMjIyE9PT29vb6KiooODg8vLy1JSUjc3N3Jycuvr6+Dg4Pb29mBgYOPj4/X19cXFxbOzs9XV1fHx8TMzMzMzMzMzMyH5BAkLAAAAIf4aQ3JlYXRlZCB3aXRoIGFqYXhsb2FkLmluZm8AIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAALAAAFLSAgjmRpnqSgCuLKAq5AEIM4zDVw03ve27ifDgfkEYe04kDIDC5zrtYKRa2WQgAh+QQJCwAAACwAAAAAEAALAAAFJGBhGAVgnqhpHIeRvsDawqns0qeN5+y967tYLyicBYE7EYkYAgAh+QQJCwAAACwAAAAAEAALAAAFNiAgjothLOOIJAkiGgxjpGKiKMkbz7SN6zIawJcDwIK9W/HISxGBzdHTuBNOmcJVCyoUlk7CEAAh+QQJCwAAACwAAAAAEAALAAAFNSAgjqQIRRFUAo3jNGIkSdHqPI8Tz3V55zuaDacDyIQ+YrBH+hWPzJFzOQQaeavWi7oqnVIhACH5BAkLAAAALAAAAAAQAAsAAAUyICCOZGme1rJY5kRRk7hI0mJSVUXJtF3iOl7tltsBZsNfUegjAY3I5sgFY55KqdX1GgIAIfkECQsAAAAsAAAAABAACwAABTcgII5kaZ4kcV2EqLJipmnZhWGXaOOitm2aXQ4g7P2Ct2ER4AMul00kj5g0Al8tADY2y6C+4FIIACH5BAkLAAAALAAAAAAQAAsAAAUvICCOZGme5ERRk6iy7qpyHCVStA3gNa/7txxwlwv2isSacYUc+l4tADQGQ1mvpBAAIfkECQsAAAAsAAAAABAACwAABS8gII5kaZ7kRFGTqLLuqnIcJVK0DeA1r/u3HHCXC/aKxJpxhRz6Xi0ANAZDWa+kEAA7" alt=""><br />Loading...</div>',state:{isDuringAjax:!1,isProcessingData:!1,isResizing:!1,isPause:!1,curPage:1},callbacks:{loadingStart:function(t){t.show()},loadingFinished:function(t,e){e?t.remove():t.fadeOut()},loadingError:function(t){t.html("Data load faild, please try again later.")},renderData:function(e,i){var s,a;return"json"===i||"jsonp"===i?(s=t("#waterfall-panel-tpl").html(),a=Handlebars.compile(s),a(e)):e}},debug:!1};a.prototype={constructor:a,_debug:function(){!0===this.options.debug&&("undefined"!=typeof console&&"function"==typeof console.log?1===Array.prototype.slice.call(arguments).length&&"string"==typeof Array.prototype.slice.call(arguments)[0]?console.log(""+Array.prototype.slice.call(arguments)):console.log(Array.prototype.slice.call(arguments)):Function.prototype.bind||"undefined"==typeof console||"object"!=typeof console.log||Function.prototype.call.call(console.log,console,Array.prototype.slice.call(arguments)))},_init:function(t){var e=this.options,i=e.path;this._resetHeight(),this._setWidth();var a=Math.floor((this.width-2*e.gutterWidth)/3),h=Math.floor(.75*a);return e.cellWidth=a,e.cellHeight=h,this._initContainer(),this.reLayout(t),i?(e.isAutoPrefill&&this._prefill(),e.resizable&&this._doResize(),this._doScroll(),s):(this._debug("Invalid path"),s)},_initContainer:function(){var e=this.options,i=e.prefix;t("body").css({overflow:"auto"}),this.$element.css(this.options.containerStyle).addClass(i+"-container"),this.$element.after('<div id="'+i+'-loading">'+e.loadingMsg+'</div><div id="'+i+'-message" style="text-align:center;color:#999;"></div>'),this.$loading=t("#"+i+"-loading"),this.$message=t("#"+i+"-message")},_getItems:function(t){var e=t.filter("."+this.options.itemCls).css({position:"absolute"});return e},_setWidth:function(){this.width=this._getWidth()},_getWidth:function(){var t=this.options,e=t.fitWidth?this.$element.parent():this.$element,i="BODY"===e[0].tagName?e.width()-20:e.width();return i},_resetHeight:function(){this.height=0},layout:function(t,e){var i,s,a,h,o,n=this,l=n.options,r=n.itemsData,g=l.isFadeIn?n._getItems(t).css({opacity:0}).animate({opacity:1}):n._getItems(t),c=l.isAnimated&&l.state.isResizing?"animate":"css",d=l.animationOptions,f=l.cellWidth,p=l.cellHeight,A=l.gutterWidth,u=l.gutterHeight,m=0,w=-1,y=0,b=(n.width,0),_=!0;for(s=0,h=r.length;h>s;){if(r[s].width||(r[s].width=l.cellWidth),r[s].height||(r[s].height=l.cellHeight),r[s].width>=3*f+2*A)y=1,b=r[s].height>=2*p+u?1:2;else if(r[s].width>=2*f+A&&r[s].height>=2*p+u){if(s+1>=h){_=!1,n._placeItems(g,s,3,h-s);break}if(r[s+1].height>=2*p+u)b=3,y=2;else{if(s+2>=h){_=!1,n._placeItems(g,s,4,h-s);break}b=4,y=3}}else if(r[s].width>=2*f+A&&2*p+u>r[s].height){if(s+1>=h){_=!1,n._placeItems(g,s,5,h-s);break}b=5,y=2}else if(2*f+A>r[s].width&&2*p+u>r[s].height){if(s+1>=h){_=!1,n._placeItems(g,s,6,h-s);break}if(2*f+A>r[s+1].width){if(s+2>=h){_=!1,n._placeItems(g,s,6,h-s);break}b=6,y=3}else b=7,y=2}else if(2*f+A>r[s].width&&r[s].height>=2*p+u){if(s+1>=h){_=!1,n._placeItems(g,s,8,h-s);break}if(r[s+1].width>=2*f+A&&r[s+1].height>=2*p+u)b=8,y=2;else if(2*f+A>r[s+1].width&&r[s+1].height>=2*p+u){if(s+2>=h){_=!1,n._placeItems(g,s,9,h-s);break}if(r[s+2].height>=2*p+u)b=9,y=3;else{if(s+3>=h){_=!1,n._placeItems(g,s,10,h-s);break}b=10,y=4}}else if(r[s+1].width>=2*f+A&&2*p+u>r[s+1].height){if(s+2>=h){_=!1,n._placeItems(g,s,11,h-s);break}if(r[s+2].width>=2*f+A)b=11,y=3;else{if(s+3>=h){_=!1,n._placeItems(g,s,12,h-s);break}b=12,y=4}}else if(2*f+A>r[s+1].width&&2*p+u>r[s+1].height){if(s+3>=h){_=!1,n._placeItems(g,s,13,h-s);break}if(r[s+3].width>=2*f+A)b=13,y=4;else{if(s+4>=h){_=!1,n._placeItems(g,s,14,h-s);break}b=14,y=5}}else b=0,y=0}else b=0,y=0;m+=1,w=s,this._placeItems(g,w,b,y),s+=y,y=0}for(a=0,o=this.styleQueue.length;o>a;a++)i=this.styleQueue[a],i.$el[c](i.style,d);this.$element.height(n.height-u),this.styleQueue=[],this.options.state.isResizing=!1,this.options.state.isProcessingData=!1,e&&e.call(g)},reLayout:function(t){var e=this,i=e.options,s=e.$element.find("."+e.options.itemCls);this._resetHeight();var a=Math.floor((e.width-2*i.gutterWidth)/3),h=Math.floor(.75*a);i.cellWidth=a,i.cellHeight=h,e.layout(s,t)},_placeItems:function(e,i,s,a){var h,o,n,l=this,r=l.height,g=(t(e[i]),l.options),c=g.align,d=(l.itemsData,g.gutterWidth),f=g.gutterHeight,p=g.cellWidth,A=g.cellHeight,u=3*p+2*d,m=2*p+d,w=2*A+f,y=[],b=Math.floor(2*Math.random());switch("center"===c?(o=(l.width-u)/2,o=o>0?o:0):"left"===c?o=0:"right"===c&&(o=l.width-u),s){case 1:h=w,y=[{left:o,top:r,width:u,height:w}];break;case 2:h=A,position=[{left:o,top:r,width:u,height:A}];break;case 3:h=w,y=[{left:0===b?o:p+d+o,top:r,width:m,height:w},{left:0===b?m+d+o:o,top:r,width:p,height:w}];break;case 4:h=w,y=[{left:0===b?o:p+d+o,top:r,width:m,height:w},{left:0===b?m+d+o:o,top:r,width:p,height:A},{left:0===b?m+d+o:o,top:r+A+f,width:p,height:A}];break;case 5:h=A,y=[{left:0===b?o:p+d+o,top:r,width:m,height:A},{left:0===b?m+d+o:o,top:r,width:p,height:A}];break;case 6:h=A,y=[{left:o,top:r,width:p,height:A},{left:p+d+o,top:r,width:p,height:A},{left:m+d+o,top:r,width:p,height:A}];break;case 7:h=A,y=[{left:0===b?o:m+d+o,top:r,width:p,height:A},{left:0===b?p+d+o:o,top:r,width:m,height:A}];break;case 8:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:0===b?p+d+o:o,top:r,width:m,height:w}];break;case 9:h=w,y=[{left:o,top:r,width:p,height:w},{left:p+d+o,top:r,width:p,height:w},{left:m+d+o,top:r,width:p,height:w}];break;case 10:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:p+d+o,top:r,width:p,height:w},{left:0===b?m+d+o:o,top:r,width:p,height:A},{left:0===b?m+d+o:o,top:r+A+f,width:p,height:A}];break;case 11:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:0===b?p+d+o:o,top:r,width:m,height:A},{left:0===b?p+d+o:o,top:r+A+f,width:m,height:A}];break;case 12:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:0===b?p+d+o:o,top:r,width:m,height:A},{left:p+d+o,top:r+A+f,width:p,height:A},{left:0===b?m+d+o:o,top:r+A+f,width:p,height:A}];break;case 13:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:p+d+o,top:r,width:p,height:A},{left:0===b?m+d+o:o,top:r,width:p,height:A},{left:0===b?p+d+o:o,top:r+A+f,width:m,height:A}];break;case 14:h=w,y=[{left:0===b?o:m+d+o,top:r,width:p,height:w},{left:p+d+o,top:r,width:p,height:A},{left:0===b?m+d+o:o,top:r,width:p,height:A},{left:p+d+o,top:r+A+f,width:p,height:A},{left:0===b?m+d+o:o,top:r+A+f,width:p,height:A}];break;default:y=[],h=0}for(n=0;a>n;n++)this.styleQueue.push({$el:t(e[i+n]),style:y[n]});l.height+=h+f},prepend:function(t,e){this._handleResponse(t,e,!1)},append:function(t,e){this._handleResponse(t,e)},removeItems:function(e,i){var s,a,h,o,n,l=this;if("number"==typeof e)l.itemsData.splice(e,1),l.$element.find("."+l.options.itemCls).eq(e).remove();else if(t.isArray(e))for(e=e.sort(function(t,e){var i=parseInt(t),s=parseInt(e);return i==s?0:s>i?-1:1}),s=0,a=e.length;a>s;s++)l.itemsData.splice(e[s]-s,1),l.$element.find("."+l.options.itemCls).eq(e[s]-s).remove();else{for(h=l.$element.find(e),s=0,a=h.length;a>s;s++)o=t(h[s]),n=o.index(),l.itemsData.splice(n-s,1);h.remove()}this.reLayout(i)},option:function(e,i){t.isPlainObject(e)&&(this.options=t.extend(!0,this.options,e),"function"==typeof i&&i(),this._init())},pause:function(t){this.options.state.isPause=!0,"function"==typeof t&&t()},resume:function(t){this.options.state.isPause=!1,"function"==typeof t&&t()},_requestData:function(e){var i,a=this,h=a.options,o=h.maxPage,n=h.state.curPage++,l=h.path,r=h.dataType,g=h.params,c=h.headers;return o!==s&&n>o?(h.state.isBeyondMaxPage=!0,h.callbacks.loadingFinished(a.$loading,h.state.isBeyondMaxPage),s):(i="function"==typeof l?l(n):l.join(n),a._debug("heading into ajax",i+t.param(g)),h.callbacks.loadingStart(a.$loading),h.state.isDuringAjax=!0,h.state.isProcessingData=!0,t.ajax({url:i,data:g,headers:c,dataType:r,success:function(t){a._handleResponse(t,e),a.options.state.isDuringAjax=!1},error:function(){a._responeseError("error")}}),s)},_handleResponse:function(e,i,a){var h,o,n=this,l=n.options,r=t.trim(l.callbacks.renderData(e,l.dataType)),g=t(r);if(l.checkImagesLoaded,a===s&&(a=!0),a){for(h=0,o=e.items.length;o>h;h++)n.itemsData.push(e.items[h]);n.$element.append(g)}else{for(o=e.items.length-1;o>-1;o--)n.itemsData.unshift(e.items[h]);n.$element.prepend(g)}n.reLayout(i),n.options.callbacks.loadingFinished(n.$loading,n.options.state.isBeyondMaxPage)},_responeseError:function(t){this.$loading.hide(),this.options.callbacks.loadingError(this.$message,t),"end"!==t&&"error"!==t&&(t="unknown"),this._debug("Error",t)},_nearbottom:function(){var t=this,e=t.options,i=h.scrollTop()+h.height()-t.$element.offset().top-t.height;return this._debug("math:",i),i>e.bufferPixel},_prefill:function(){this.$element.height()<=h.height()&&this._scroll()},_scroll:function(){var t=this,e=t.options,i=e.state;i.isProcessingData||i.isDuringAjax||i.isInvalidPage||i.isPause||this._nearbottom()&&this._requestData(function(){setTimeout(function(){t._scroll()},100)})},_doScroll:function(){var t,e=this;h.bind("scroll",function(){t&&clearTimeout(t),t=setTimeout(function(){e._scroll()},100)})},_resize:function(){var t=this.width,e=this._getWidth();e!==t&&(this.options.state.isResizing=!0,this.width=e,this.reLayout(),this._prefill())},_doResize:function(){var t,e=this;h.bind("resize",function(){t&&clearTimeout(t),t=setTimeout(function(){e._resize()},100)})}},t.fn[o]=function(e){if("string"==typeof e){var i=Array.prototype.slice.call(arguments,1);this.each(function(){var a=t.data(this,"plugin_"+o);return a?t.isFunction(a[e])&&"_"!==e.charAt(0)?(a[e].apply(a,i),s):(a._debug('no such method "'+e+'"'),s):(a._debug("instance is not initialization"),s)})}else this.each(function(){t.data(this,"plugin_"+o)||t.data(this,"plugin_"+o,new a(this,e))});return this}})(jQuery,window,document);